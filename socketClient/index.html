<!DOCTYPE html>
<html>
<head>
	<title>Share watch</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="socket.io.min.js"></script>
</head>
<body>
	<video controls id="videoMain" width="1280" height="720"></video>
	<div id="sessionData"></div>

	<script type="text/javascript">
		let div = document.getElementById("sessionData");
		let video = document.getElementById("videoMain");

		let socketB = false;
		let interval;
		var wasBuffering = false;

		const socket = io("http://DOMAIN_NAME:62341");

		socket.on("connect", () => {  
			div.innerText = "connection ok"; 
			socket.emit("video");
			interval = setInterval(checkState, 4000)
		});

		socket.on("newInfo", () => {
			div.innerText = "new info";
			video.src = "";
			socket.emit("video");
		});

		socket.on("disconnect", () => {  
			div.innerText = "connection drop :("
			clearInterval(interval);
			interval = null;
		});

		socket.on("video", (v) => { 
			video.src = v;
			socket.emit("state")
		});

		socket.on("message", (v) => { 
			div.innerText = "connection ok. msg from server: "+v
		});

		socket.on("state", (v) => {
			console.log("state", v);
			console.log("block socket state");
			socketB = true
			if(v == 0){
				console.log("not init")
				video.pause()
				video.currentTime = 0
			}
			if(v == 1){
				if(video.paused == false){
					video.pause()
				}else{
					socketB = false
				}
			}
			if(v == 2){
				if(video.paused == true){
					video.play()
				}else{
					socketB = false
				}
			}
		});

		socket.on("time", (v) => {
			console.log("time", v);
			if (Math.abs(v - video.currentTime) > 2){
				console.log("block socket time");
				video.currentTime = v
				socketB = true
			}
		});

		video.onseeked = (event) => {
			if(socketB == false){
  				socket.emit("setTime", parseInt(video.currentTime))
  			}
  			socketB = false
		};

		video.onplay = (event) => {
			console.log(socketB);
		  	if(socketB == false){
		  		socket.emit("setState", 2)
			}
			socketB = false
		};

		video.onpause = (event) => {
			console.log(socketB);
		  	if(socketB == false){
		  		socket.emit("setState", 1)
			}
			socketB = false
		};

		video.addEventListener('waiting', (event) => {
			socket.emit("buffering", 1);
			socketB = false;
			wasBuffering = true;
		});

		video.addEventListener('playing', (event) => {
			if(wasBuffering == true){
				socket.emit("buffering", 0);
				socketB = false;
				wasBuffering = false;

				video.play();
			}
		});


		function checkState(){
			socket.emit("state")
			socket.emit("progress")
		}
	</script>
</body>
</html>